{"version":3,"file":"js/838.ce7b3420.js","mappings":"wYAmDA,MAAMA,GAAeC,EAAAA,EAAAA,KACfC,GAAgBC,EAAAA,EAAAA,KAChBC,GAAYC,EAAAA,EAAAA,KAAI,GAChBC,GAAYD,EAAAA,EAAAA,IAAI,MAChBE,GAAmBF,EAAAA,EAAAA,IAAI,MACvBG,EAASR,EAAaS,QACtBC,EAAUV,EAAaW,SACvBC,GAAIP,EAAAA,EAAAA,IAAI,GACRQ,GAAIR,EAAAA,EAAAA,IAAI,GACRS,GAAeT,EAAAA,EAAAA,IAAI,MACnBU,GAAYV,EAAAA,EAAAA,IAAI,MAChBW,GAAcX,EAAAA,EAAAA,IAAI,MA8BxB,IAAIY,EACJ,SAASC,IACPC,aAAaF,GACbA,EAAkBG,YAAW,KAC3BC,GAAe,GACd,IACL,CACA,SAASA,IACP,MAAMC,EAAkBtB,EAAauB,cAAgB,IACrDP,EAAYQ,MAAMC,QAAQ,YAAa,CAAEC,OAAQJ,IAAmB,EACtE,CAGA,SAASK,EAAcC,GACrB,MAAMC,EAAgB7B,EAAa8B,YAAYC,YACzCC,EAAiBhC,EAAa8B,YAAYG,aAC1CC,EAAalC,EAAa8B,YAAYK,gBAAkB,IACxDC,EAAepC,EAAa8B,YAAYO,YAAc,IAE5D9B,EAAiBiB,MAAQI,EAAM5B,EAAasC,cAG5C,MAAMC,EAAeV,EAAgBK,EAC/BM,EAAgBR,EAAiBE,EAGjCO,EAAO,EAAIC,EAAQC,KAAKC,KAAKL,EAAe,EAAIH,IAChDS,EAAO,EAAIH,EAAQC,KAAKC,KAAKJ,EAAgB,EAAIJ,IAGjDU,EAASL,EAAOlC,EAAiBiB,MACjCuB,EAASF,EAAOtC,EAAiBiB,MAEvCxB,EAAagD,SAAWF,EACxB9C,EAAaiD,UAAYF,CAC3B,CAEA,SAASG,IACP,IAAItB,EAAM5B,EAAa4B,IACvBD,EAAcC,GACduB,QAAQC,IAAI,mBAAoBxB,GAChC,MAAO5B,EAAagD,SAAW,IAAMhD,EAAasC,cAIhD,GAHAV,GAAO,EACPD,EAAcC,GACduB,QAAQC,IAAI,mBAAoBpD,EAAa4B,KACzCA,EAAM,GAAI,CACZuB,QAAQE,KAAK,yBACb,KACF,CAEFrD,EAAa4B,IAAMA,CACrB,CAGA,SAAS0B,EAAOC,GACd3C,EAAEY,OAAS+B,EAAEC,MAAM,GACnB3C,EAAEW,OAAS+B,EAAEC,MAAM,GAGf5C,EAAEY,MAAQ,IAAGZ,EAAEY,MAAQ,GACvBX,EAAEW,MAAQ,IAAGX,EAAEW,MAAQ,GACvBZ,EAAEY,MAAQxB,EAAasC,cAAgBtC,EAAagD,WACtDpC,EAAEY,MAAQxB,EAAasC,cAAgBtC,EAAagD,UAClDnC,EAAEW,MAAQxB,EAAasC,cAAgBtC,EAAaiD,YACtDpC,EAAEW,MAAQxB,EAAasC,cAAgBtC,EAAaiD,WAEtDQ,GACF,CAEAC,eAAeC,IACb,IACE,MAAMC,EAAK5D,EAAaS,QAClBoD,EAAM7D,EAAaW,SACnBmD,EAAQ9D,EAAasC,cACrByB,EAAS/D,EAAasC,cACtBV,EAAM5B,EAAa4B,IACnBoC,EAAW9D,EAAc+D,QAAQC,aAEvCvC,EAAc3B,EAAa4B,KAEvBtB,EAAUkB,OACZ2C,IAAIC,gBAAgB9D,EAAUkB,OAEhClB,EAAUkB,YAAc6C,EAAAA,EAAWC,gBAAgBR,EAAOC,EAAQnC,EAAKgC,EAAIC,EAAKG,EAClF,CAAE,MAAOO,GACPpB,QAAQoB,MAAM,kCAAmCA,EACnD,CACF,CAEAb,eAAec,IACb,IACE,MAAMC,QAAaJ,EAAAA,EAAWK,cAAc,QAC5C1E,EAAa8B,YAAc2C,EAAKE,QAClC,CAAE,MAAOJ,GACPpB,QAAQoB,MAAM,uCAAwCA,EACxD,CACF,CAEA,SAASd,IAEP,MAAMmB,EAAgBhE,EAAEY,MAAQxB,EAAagD,SAAW,EAClD6B,EAAgBhE,EAAEW,MAAQxB,EAAaiD,UAAY,EAGnD6B,EAAS9E,EAAasC,cAAgB,EAGtCyC,EAASH,EAAgBE,EACzBE,EAASF,EAASD,EAGlBI,EAAYD,EAASzE,EAAiBiB,MAG5C,IAAI0D,EAASvC,KAAKwC,IAAKzE,EAAUiC,KAAKyC,GAAM,KACxCzC,KAAK0C,IAAIH,GAAU,OAAMA,EAAS,MACtC,MAAMI,EAAYP,EAASxE,EAAiBiB,MAAS0D,EAG/CK,EAAY/E,EAAS8E,EACrBE,EAAa9E,EAAUuE,EAG7BjF,EAAayF,cAAgBC,EAAaH,GAC1CvF,EAAa2F,eAAiBC,EAAaJ,GAE3CxF,EAAaS,QAAU8E,EACvBvF,EAAaW,SAAW6E,CAC1B,CAEA,SAASE,EAAaG,GACpB,MAAMC,EAAaD,EAAM,GACnBE,EAAIpD,KAAKqD,MAAMF,GACfG,EAAiBH,EAAaC,EAC9BG,EAAgC,GAAjBD,EACfE,EAAIxD,KAAKqD,MAAME,GACfE,EAAmBF,EAAeC,EAClCE,EAAuB,GAAnBD,EAEJE,EAAOC,OAAOR,GACdS,EAAOD,OAAOJ,GAAGM,SAAS,EAAG,KAC7BC,EAAOL,EAAEM,QAAQ,GAAGF,SAAS,EAAG,KAEtC,MAAO,GAAGH,KAAQE,KAAQE,GAC5B,CACA,SAASd,EAAaC,GACpB,MAAMe,EAAOf,EAAM,EAAI,IAAM,IAC7BA,EAAMlD,KAAK0C,IAAIQ,GACf,MAAMgB,EAAIlE,KAAKqD,MAAMH,GACfiB,EAAejB,EAAMgB,EACrBX,EAA8B,GAAfY,EACfX,EAAIxD,KAAKqD,MAAME,GACfE,EAAmBF,EAAeC,EAClCE,EAAuB,GAAnBD,EAEJW,EAAOR,OAAOM,GAAGJ,SAAS,EAAG,KAC7BD,EAAOD,OAAOJ,GAAGM,SAAS,EAAG,KAC7BC,EAAOL,EAAEM,QAAQ,GAAGF,SAAS,EAAG,KAEtC,MAAO,GAAGG,IAAOG,KAAQP,KAAQE,GACnC,CACA,SAAShE,EAAQsE,GACf,OAAOA,GAAO,IAAMrE,KAAKyC,GAC3B,C,OA/LA6B,EAAAA,EAAAA,KAAUvD,gBACFc,IAGN,MAAM0C,EAAmBvE,KAAKwE,IAAIC,OAAOC,WAAYD,OAAOE,YAAc,KACpEC,EAAwD,IAArC5E,KAAKqD,MAAMkB,EAAmB,KACvDlH,EAAasC,cAAgBiF,EAC7BrE,UAEMS,IAGN/C,EAAEY,MAAQxB,EAAasC,cAAgB,EAAItC,EAAagD,SAAW,EACnEnC,EAAEW,MAAQxB,EAAasC,cAAgB,EAAItC,EAAaiD,UAAY,QAE9DuE,EAAAA,EAAAA,YACA,IAAIC,SAASC,GAAYtG,WAAWsG,EAAS,OACnDtH,EAAUoB,OAAQ,CAAK,KAGzBmG,EAAAA,EAAAA,KACE,IAAM3H,EAAauB,gBACnB,KACE4B,QAAQC,IAAI,uBAAwBpD,EAAauB,eACjDL,GAAqB,I,82BClFzB,MAAM0G,GAA2B,OAAgB,EAAQ,CAAC,CAAC,YAAY,qBAEvE,O","sources":["webpack://nina-webapp/./src/components/framing/FramingAssitantImg.vue","webpack://nina-webapp/./src/components/framing/FramingAssitantImg.vue?602d"],"sourcesContent":["<template>\n  <div v-if=\"isLoading\" class=\"flex items-center justify-center min-h-screen\">\n    <div\n      class=\"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin\"\n    ></div>\n  </div>\n  <div v-else>\n    <div\n      id=\"fov\"\n      class=\"border relative overflow-hidden\"\n      :style=\"{\n        width: `${framingStore.containerSize}px`,\n        height: `${framingStore.containerSize}px`,\n        position: 'relative',\n      }\"\n      ref=\"containerRef\"\n    >\n      <!-- TargetPic als Hintergrund -->\n      <img class=\"absolute inset-0\" :src=\"targetPic\" />\n\n      <!-- Verschiebbares / drehbares Ziel-Element -->\n      <div\n        class=\"target\"\n        ref=\"targetRef\"\n        :style=\"{\n          width: `${framingStore.camWidth}px`,\n          height: `${framingStore.camHeight}px`,\n          transform: `translate(${x}px, ${y}px) rotate(${-framingStore.rotationAngle}deg)`,\n          zIndex: 2,\n        }\"\n      ></div>\n\n      <!-- Moveable-->\n      <Moveable\n        ref=\"moveableRef\"\n        :target=\"targetRef\"\n        :draggable=\"true\"\n        :rotatable=\"false\"\n        @drag=\"onDrag\"\n      />\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { ref, onMounted, nextTick, watch } from 'vue';\nimport Moveable from 'vue3-moveable';\nimport { useFramingStore } from '@/store/framingStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport apiService from '@/services/apiService';\n\nconst framingStore = useFramingStore();\nconst settingsStore = useSettingsStore();\nconst isLoading = ref(true);\nconst targetPic = ref(null);\nconst scaleDegPerPixel = ref(0.004); // Grad pro Pixel\nconst baseRA = framingStore.RAangle;\nconst baseDec = framingStore.DECangle;\nconst x = ref(0);\nconst y = ref(0);\nconst containerRef = ref(null);\nconst targetRef = ref(null);\nconst moveableRef = ref(null);\n\nonMounted(async () => {\n  await fetchFramingInfo();\n\n  // Container-Größe berechnen\n  const smallerDimension = Math.min(window.innerWidth, window.innerHeight - 200);\n  const roundedDimension = Math.floor(smallerDimension / 100) * 100;\n  framingStore.containerSize = roundedDimension;\n  setMinTargetFov();\n  // Bild abrufen\n  await getTargetPic();\n\n  // Element in die Mitte setzen\n  x.value = framingStore.containerSize / 2 - framingStore.camWidth / 2;\n  y.value = framingStore.containerSize / 2 - framingStore.camHeight / 2;\n\n  await nextTick();\n  await new Promise((resolve) => setTimeout(resolve, 500));\n  isLoading.value = false;\n});\n\nwatch(\n  () => framingStore.rotationAngle,\n  () => {\n    console.log('debounceRotateRange:', framingStore.rotationAngle);\n    debounceRotateRange();\n  }\n);\n\nlet debounceTimeout;\nfunction debounceRotateRange() {\n  clearTimeout(debounceTimeout);\n  debounceTimeout = setTimeout(() => {\n    rotateByRange();\n  }, 500); // Wartezeit in Millisekunden\n}\nfunction rotateByRange() {\n  const normalizedAngle = framingStore.rotationAngle % 360; // Sicherstellen, dass der Wert im Bereich 0-360 bleibt\n  moveableRef.value.request('rotatable', { rotate: normalizedAngle }, true);\n}\n\n// Methode, um Kamera-FOV und das verschiebbare Rechteck zu berechnen\nfunction calcCameraFov(fov) {\n  const sensorWidthPx = framingStore.framingInfo.CameraWidth;\n  const sensorHeightPx = framingStore.framingInfo.CameraHeight;\n  const pixelSizeM = framingStore.framingInfo.CameraPixelSize / 1_000_000;\n  const focalLengthM = framingStore.framingInfo.FocalLength / 1000;\n\n  scaleDegPerPixel.value = fov / framingStore.containerSize;\n\n  // Sensor-Größe\n  const sensorWidthM = sensorWidthPx * pixelSizeM;\n  const sensorHeightM = sensorHeightPx * pixelSizeM;\n\n  // FOV in Grad\n  const fovX = 2 * rad2deg(Math.atan(sensorWidthM / 2 / focalLengthM));\n  const fovY = 2 * rad2deg(Math.atan(sensorHeightM / 2 / focalLengthM));\n\n  // FOV in Pixel\n  const fovPxX = fovX / scaleDegPerPixel.value;\n  const fovPxY = fovY / scaleDegPerPixel.value;\n\n  framingStore.camWidth = fovPxX;\n  framingStore.camHeight = fovPxY;\n}\n\nfunction setMinTargetFov() {\n  let fov = framingStore.fov;\n  calcCameraFov(fov);\n  console.log('setMinTargetFov ', fov);\n  while (framingStore.camWidth + 200 > framingStore.containerSize) {\n    fov += 1;\n    calcCameraFov(fov);\n    console.log('fov hochgesetzt:', framingStore.fov);\n    if (fov > 50) {\n      console.warn('Fov zu hoch, Abbruch!');\n      break;\n    }\n  }\n  framingStore.fov = fov; // Aktualisiere `framingStore.fov`\n}\n\n// Drag-Event von Moveable\nfunction onDrag(e) {\n  x.value += e.delta[0];\n  y.value += e.delta[1];\n\n  // Begrenzung: nicht über Container hinausragen\n  if (x.value < 0) x.value = 0;\n  if (y.value < 0) y.value = 0;\n  if (x.value > framingStore.containerSize - framingStore.camWidth)\n    x.value = framingStore.containerSize - framingStore.camWidth;\n  if (y.value > framingStore.containerSize - framingStore.camHeight)\n    y.value = framingStore.containerSize - framingStore.camHeight;\n\n  calculateRaDec();\n}\n\nasync function getTargetPic() {\n  try {\n    const ra = framingStore.RAangle;\n    const dec = framingStore.DECangle;\n    const width = framingStore.containerSize;\n    const height = framingStore.containerSize;\n    const fov = framingStore.fov;\n    const useCache = settingsStore.framing.useNinaCache;\n\n    calcCameraFov(framingStore.fov);\n\n    if (targetPic.value) {\n      URL.revokeObjectURL(targetPic.value);\n    }\n    targetPic.value = await apiService.searchTargetPic(width, height, fov, ra, dec, useCache);\n  } catch (error) {\n    console.error('Fehler beim Abrufen des Bildes:', error);\n  }\n}\n\nasync function fetchFramingInfo() {\n  try {\n    const data = await apiService.framingAction('info');\n    framingStore.framingInfo = data.Response;\n  } catch (error) {\n    console.error('Fehler beim Abrufen des FramingInfo:', error);\n  }\n}\n\nfunction calculateRaDec() {\n  // Center des Ziel-Rechtecks\n  const targetCenterX = x.value + framingStore.camWidth / 2;\n  const targetCenterY = y.value + framingStore.camHeight / 2;\n\n  // Container-Mitte\n  const center = framingStore.containerSize / 2;\n\n  // Abweichung in Pixel\n  const deltaX = targetCenterX - center;\n  const deltaY = center - targetCenterY;\n\n  // Offset DEC\n  const offsetDec = deltaY * scaleDegPerPixel.value;\n\n  // RA-Korrektur (cos(dec))\n  let cosDec = Math.cos((baseDec * Math.PI) / 180);\n  if (Math.abs(cosDec) < 1e-8) cosDec = 1e-8;\n  const offsetRA = (deltaX * scaleDegPerPixel.value) / cosDec;\n\n  // Aktuelle Koords\n  const currentRA = baseRA - offsetRA;\n  const currentDec = baseDec + offsetDec;\n\n  // Als String speichern\n  framingStore.RAangleString = degreesToHMS(currentRA);\n  framingStore.DECangleString = degreesToDMS(currentDec);\n\n  framingStore.RAangle = currentRA;\n  framingStore.DECangle = currentDec;\n}\n\nfunction degreesToHMS(deg) {\n  const totalHours = deg / 15;\n  const h = Math.floor(totalHours);\n  const remainingHours = totalHours - h;\n  const totalMinutes = remainingHours * 60;\n  const m = Math.floor(totalMinutes);\n  const remainingMinutes = totalMinutes - m;\n  const s = remainingMinutes * 60;\n\n  const hStr = String(h);\n  const mStr = String(m).padStart(2, '0');\n  const sStr = s.toFixed(1).padStart(4, '0');\n\n  return `${hStr}:${mStr}:${sStr}`;\n}\nfunction degreesToDMS(deg) {\n  const sign = deg < 0 ? '-' : '+';\n  deg = Math.abs(deg);\n  const d = Math.floor(deg);\n  const remainingDeg = deg - d;\n  const totalMinutes = remainingDeg * 60;\n  const m = Math.floor(totalMinutes);\n  const remainingMinutes = totalMinutes - m;\n  const s = remainingMinutes * 60;\n\n  const dStr = String(d).padStart(2, '0');\n  const mStr = String(m).padStart(2, '0');\n  const sStr = s.toFixed(1).padStart(4, '0');\n\n  return `${sign}${dStr}:${mStr}:${sStr}`;\n}\nfunction rad2deg(rad) {\n  return rad * (180 / Math.PI);\n}\n</script>\n\n<style scoped>\n.target {\n  position: absolute;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border: 1px dashed red;\n}\n</style>\n","import script from \"./FramingAssitantImg.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./FramingAssitantImg.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./FramingAssitantImg.vue?vue&type=style&index=0&id=1ac87e28&scoped=true&lang=css\"\n\nimport exportComponent from \"../../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['__scopeId',\"data-v-1ac87e28\"]])\n\nexport default __exports__"],"names":["framingStore","useFramingStore","settingsStore","useSettingsStore","isLoading","ref","targetPic","scaleDegPerPixel","baseRA","RAangle","baseDec","DECangle","x","y","containerRef","targetRef","moveableRef","debounceTimeout","debounceRotateRange","clearTimeout","setTimeout","rotateByRange","normalizedAngle","rotationAngle","value","request","rotate","calcCameraFov","fov","sensorWidthPx","framingInfo","CameraWidth","sensorHeightPx","CameraHeight","pixelSizeM","CameraPixelSize","focalLengthM","FocalLength","containerSize","sensorWidthM","sensorHeightM","fovX","rad2deg","Math","atan","fovY","fovPxX","fovPxY","camWidth","camHeight","setMinTargetFov","console","log","warn","onDrag","e","delta","calculateRaDec","async","getTargetPic","ra","dec","width","height","useCache","framing","useNinaCache","URL","revokeObjectURL","apiService","searchTargetPic","error","fetchFramingInfo","data","framingAction","Response","targetCenterX","targetCenterY","center","deltaX","deltaY","offsetDec","cosDec","cos","PI","abs","offsetRA","currentRA","currentDec","RAangleString","degreesToHMS","DECangleString","degreesToDMS","deg","totalHours","h","floor","remainingHours","totalMinutes","m","remainingMinutes","s","hStr","String","mStr","padStart","sStr","toFixed","sign","d","remainingDeg","dStr","rad","onMounted","smallerDimension","min","window","innerWidth","innerHeight","roundedDimension","nextTick","Promise","resolve","watch","__exports__"],"sourceRoot":""}